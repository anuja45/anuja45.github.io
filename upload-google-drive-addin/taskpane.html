<!DOCTYPE html>
<html>
  <head>
    <title>Send to Google Drive</title>
    <script src="https://apis.google.com/js/api.js"></script>
  </head>
  <body>
    <h1>Send Attachments to Google Drive</h1>
    <button id="sendToDrive">Send Attachments to Google Drive</button>
    <div id="status"></div>
  </body>
  <script>
    Office.onReady(() => {
      if(Office.context.mailbox){
        console.log("Add-in is ready")
      }
    });

    // Fetch attachments and upload to Google Drive
    async function sendToGoogleDrive() {
      try {
        const item = Office.context.mailbox.item;

        if (!item.attachments || item.attachments.length === 0) {
          document.getElementById("status").innerText =
            "No attachments found in this email.";
          return;
        }

        document.getElementById("status").innerText =
          "Processing attachments...";

        // Authenticate with Google Drive API
        const token = await authenticateWithGoogle();

        for (const attachment of item.attachments) {
          const attachmentContent = await getAttachmentContent(attachment.id);

          // Upload to Google Drive
          const response = await uploadToGoogleDrive(
            token,
            attachment.name,
            attachmentContent
          );

          if (response.ok) {
            document.getElementById(
              "status"
            ).innerText = `Uploaded: ${attachment.name}`;
          } else {
            document.getElementById(
              "status"
            ).innerText = `Failed to upload: ${attachment.name}`;
          }
        }
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText =
          "Error occurred during upload.";
      }
    }

    // Get the attachment content
    function getAttachmentContent(attachmentId) {
      return new Promise((resolve, reject) => {
        Office.context.mailbox.getCallbackTokenAsync(
          { isRest: true },
          (result) => {
            if (result.status === Office.AsyncResultStatus.Succeeded) {
              const ewsUrl = Office.context.mailbox.ewsUrl;
              const attachmentUrl = `${ewsUrl}/ews/exchange.asmx`;

              fetch(attachmentUrl, {
                method: "POST",
                headers: {
                  "Content-Type": "application/soap+xml",
                },
                body: `<AttachmentId>${attachmentId}</AttachmentId>`, // Adjust this SOAP request format if needed
              })
                .then((response) => response.blob())
                .then(resolve)
                .catch(reject);
            } else {
              reject(result.error);
            }
          }
        );
      });
    }

    // Authenticate with Google
    async function authenticateWithGoogle() {
      const CLIENT_ID = "1053749502683-b154jhi9inbr2vqbsb59eai21l59af3m.apps.googleusercontent.com";
      const API_KEY = "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";
      const SCOPES = "https://www.googleapis.com/auth/drive.file";

      return new Promise((resolve, reject) => {
        gapi.load("client:auth2", () => {
          gapi.client
            .init({ apiKey: API_KEY, clientId: CLIENT_ID, scope: SCOPES })
            .then(() => {
              gapi.auth2
                .getAuthInstance()
                .signIn()
                .then((user) => {
                  resolve(user.getAuthResponse().access_token);
                });
            })
            .catch(reject);
        });
      });
    }

    // Upload to Google Drive
    async function uploadToGoogleDrive(token, fileName, fileContent) {
      return fetch(
        "https://www.googleapis.com/upload/drive/v3/files?uploadType=media",
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/octet-stream",
            "Content-Disposition": `attachment; filename="${fileName}"`,
          },
          body: fileContent,
        }
      );
    }

    document.getElementById("sendToDrive").onclick = sendToGoogleDrive;
  </script>
</html>
