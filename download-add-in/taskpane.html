<!DOCTYPE html>
<html>
  <head>
    <title>Download Attachment</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      h1 {
        font-size: 18px;
        margin-bottom: 10px;
      }
      #attachmentList {
        margin-top: 15px;
        padding-left: 15px;
      }
      li {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Email Attachments</h1>
    <button id="downloadAttachment">Download Attachments</button>
    <ul id="attachmentList"></ul>
  </body>
  <script>
    // Wait for Office to be ready
    Office.onReady(() => {
      if (Office.context.mailbox) {
        console.log("Add-in is ready!");
      }
    });

    // function downloadAttachment(attachment) {
    //   office.context.mailbox.getAttachmentContentAsync(
    //     attachment.id,
    //     function (result) {
    //       if (result.status === Office.AsyncResultStatus.Succeded) {
    //         const attachmentContent = result.value.content;
    //         const blob = new Blob([attachmentContent], {
    //           type: "application/octet-stream",
    //         });
    //         const link = document.createElement("a");
    //         link.href = URL.createObjectURL(blob);
    //         link.download = attachment.name;
    //         document.body.appendChild(link);
    //         link.click();
    //         document.body.removeChild(link);
    //       } else {
    //         document.getElementById("attachmentList").textContent =
    //           "No attachments found.";
    //       }
    //     }
    //   );
    // }

    function downloadAttachment(attachment) {
      Office.context.mailbox.getAttachmentContentAsync(
        attachment.id,
        function (result) {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            const attachmentContent = result.value;

            // Check the format of the attachment content
            if (
              attachmentContent.format ===
              Office.MailboxEnums.AttachmentContentFormat.Base64
            ) {
              // Decode the base64 content
              const blob = base64ToBlob(
                attachmentContent.content,
                attachmentContent.mimeType
              );

              // Create a download link for the blob
              const link = document.createElement("a");
              link.href = URL.createObjectURL(blob);
              link.download = attachment.name; // Set the filename for download
              document.body.appendChild(link);
              link.click(); // Trigger the download
              document.body.removeChild(link);
            } else {
              console.error(
                "Unsupported attachment format: " + attachmentContent.format
              );
              alert(
                "Unsupported attachment format: " + attachmentContent.format
              );
            }
          } else {
            console.error(
              "Failed to get attachment content: " + result.error.message
            );
            alert(
              "Failed to download attachment. Error: " + result.error.message
            );
          }
        }
      );
    }

    // Helper function to convert base64 to Blob
    function base64ToBlob(base64, mimeType) {
      const binaryString = atob(base64); // Decode base64
      const len = binaryString.length;
      const bytes = new Uint8Array(len);

      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }

      return new Blob([bytes], { type: mimeType });
    }
    
    function downloadAll() {
      const item = Office.context.mailbox.item;
      if (item.attachments && item.attachments.length > 0) {
        item.attachments.forEach((attachment) => {
          download(attachment);
        });
      } else {
        alert("No attachment found");
      }
    }

    // Bind the button to the function
    document.getElementById("downloadAttachment").onclick = downloadAll;
  </script>
</html>
